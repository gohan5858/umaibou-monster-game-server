# 3D Real-time Battle Game Server

actix-webã§å®Ÿè£…ã—ãŸ3Dãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦ã‚²ãƒ¼ãƒ ã®ã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚

## ğŸ¯ æ¦‚è¦

2äººå¯¾æˆ¦å‹ã®3Dãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒˆãƒ«ã‚²ãƒ¼ãƒ ç”¨ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…ã€‚
WebSocketã«ã‚ˆã‚‹60Hzã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹é…ä¿¡ã¨REST APIã«ã‚ˆã‚‹ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

## âœ¨ æ©Ÿèƒ½

### ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒƒãƒãƒ³ã‚°

- ãƒãƒƒãƒãƒ³ã‚°ä½œæˆãƒ»å‚åŠ ï¼ˆWebSocketï¼‰
- ãƒãƒƒãƒãƒ³ã‚°ä¸€è¦§å–å¾—ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆWebSocketï¼‰
- ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸé€šçŸ¥ï¼ˆWebSocketï¼‰
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ»æº–å‚™å®Œäº†ï¼ˆWebSocketï¼‰
- ã‚²ãƒ¼ãƒ é–‹å§‹é€šçŸ¥ï¼ˆWebSocketï¼‰

### ã‚²ãƒ¼ãƒ é€²è¡Œç®¡ç†

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ“ä½œå…¥åŠ›å—ä¿¡ï¼ˆç§»å‹•ãƒ»æ”»æ’ƒãƒ»å›è»¢ï¼‰
- ã‚²ãƒ¼ãƒ çŠ¶æ…‹è¨ˆç®—ãƒ»é…ä¿¡ï¼ˆ60Hzï¼‰
- å‹æ•—åˆ¤å®šãƒ»ã‚²ãƒ¼ãƒ çµ‚äº†é€šçŸ¥
- æˆ¦ç¸¾ãƒ‡ãƒ¼ã‚¿ç®¡ç†

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å‰ææ¡ä»¶

- Rust 1.70ä»¥é™
- Cargo

### ãƒ“ãƒ«ãƒ‰ & èµ·å‹•

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### æ¦‚è¦

- **ãƒˆãƒªã‚¬ãƒ¼**: `main`ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãï¼ˆãƒãƒ¼ã‚¸å«ã‚€ï¼‰
- **ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•**: GitHub Actions + `tsh scp`
- **ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ**: `ct108` (TeleportçµŒç”±)

### åˆæœŸè¨­å®š

#### 1. Identity Fileã®ç™ºè¡Œ

ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€èªè¨¼ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

```bash
# Teleportã«ãƒ­ã‚°ã‚¤ãƒ³
tsh login --proxy=teleport.localhouse.jp:443 --user=your-username

# Identity Fileã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæœ‰åŠ¹æœŸé™ã«æ³¨æ„ï¼‰
tsh identity export teleport-auth.pem
```

#### 2. GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®š

ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

- **`TELEPORT_IDENTITY`**: ä¸Šè¨˜ã§ä½œæˆã—ãŸ `teleport-auth.pem` ã®ä¸­èº«ã‚’ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘
- **`DEPLOY_USER`**: ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚µãƒ¼ãƒãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä¾‹: `gohan`ï¼‰

### ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

#### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰

```bash
# æ©Ÿèƒ½é–‹ç™º
git checkout -b feature/new-feature
# ... é–‹ç™ºä½œæ¥­ ...
git commit -m "feat: add new feature"

# mainã«ãƒãƒ¼ã‚¸ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•å®Ÿè¡Œ
git checkout main
git merge feature/new-feature
git push origin main
```

#### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

GitHub Actionsã®ç”»é¢ã‹ã‚‰ **Run workflow** ã§æ‰‹å‹•å®Ÿè¡Œå¯èƒ½ã€‚

### ãƒ‡ãƒ—ãƒ­ã‚¤ã®ç¢ºèª

```bash
# ã‚µãƒ¼ãƒãƒ¼ã«SSHæ¥ç¶š
tsh ssh your-username@ct108

# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
pgrep -f umaibou-monster-game-server

# ãƒ­ã‚°ã®ç¢ºèª
tail -f ~/Projects/umaibou-monster-game-server/server.log
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰
export DEPLOY_USER=your-username
./scripts/rollback.sh
```

## ğŸ“¡ APIä»•æ§˜

### REST API

#### 3Dãƒ¢ãƒ‡ãƒ«ä¸€è¦§å–å¾—

```bash
GET /api/models

# Response
[
  {
    "id": "model_id",
    "name": "warrior.glb",
    "is_used": false
  }
]
```

### WebSocket

#### æ¥ç¶š

```
ws://localhost:8080/ws?player_id={player_id}&matching_id={matching_id}
```

- `player_id`: ä»»æ„ï¼ˆæŒ‡å®šãªã—ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰
- `matching_id`: ä»»æ„ï¼ˆå†æ¥ç¶šæ™‚ã«æŒ‡å®šï¼‰

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼:**
- `CreateMatching` - ãƒãƒƒãƒãƒ³ã‚°ä½œæˆï¼ˆ`username` æŒ‡å®šå¯ï¼‰
- `JoinMatch` - ãƒãƒƒãƒãƒ³ã‚°å‚åŠ 
- `Ready` - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ»æº–å‚™å®Œäº†
- `Input` - æ“ä½œå…¥åŠ›ï¼ˆç§»å‹•ãƒ»æ”»æ’ƒãƒ»å›è»¢ï¼‰

**ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:**
- `MatchingCreated` - ãƒãƒƒãƒãƒ³ã‚°ä½œæˆå®Œäº†é€šçŸ¥
- `UpdateMatchings` - ãƒãƒƒãƒãƒ³ã‚°ä¸€è¦§æ›´æ–°
- `MatchingEstablished` - ãƒãƒƒãƒãƒ³ã‚°æˆç«‹ï¼ˆç›¸æ‰‹æ±ºå®šï¼‰
- `OpponentCharacterSelected` - ç›¸æ‰‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
- `GameStart` - ã‚²ãƒ¼ãƒ é–‹å§‹
- `OpponentStateUpdate` - ç›¸æ‰‹ã®çŠ¶æ…‹æ›´æ–°
- `GameEnd` - ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ»çµæœ
- `Error` - ã‚¨ãƒ©ãƒ¼é€šçŸ¥

è©³ç´°ã¯ [WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜](doc/websocket-messages.md) ã‚’å‚ç…§ã€‚

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### è‡ªå‹•ãƒ†ã‚¹ãƒˆ

```bash
# ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
cargo test --test matching_logic_test

# WebSocketãƒ†ã‚¹ãƒˆ
cargo test --test websocket_test

# ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ãƒ†ã‚¹ãƒˆ
cargo test --test model_usage_test

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cargo test
```

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

è©³ç´°ãªæ‰‹é †ã¯ [ãƒ†ã‚¹ãƒˆæ‰‹é †æ›¸](doc/testing-guide.md) ã‚’å‚ç…§ã€‚

```bash
# WebSocketã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g wscat

# WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆ
wscat -c "ws://localhost:8080/ws?player_id=player_a"
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
.
â”œâ”€â”€ Cargo.toml                  # ä¾å­˜é–¢ä¿‚å®šç¾©
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs                  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ main.rs                 # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
â”‚   â”œâ”€â”€ models.rs               # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ utils.rs                # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ models.rs           # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ game/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ state.rs            # ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
â”‚   â”‚   â””â”€â”€ manager.rs          # 60Hzã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ model_upload.rs     # ãƒ¢ãƒ‡ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰API
â”‚       â””â”€â”€ websocket.rs        # WebSocketãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ matching_logic_test.rs  # ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ model_usage_test.rs     # ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ websocket_test.rs       # WebSocketãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ run_tests.sh            # è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ doc/
    â”œâ”€â”€ specification.md        # ä»•æ§˜æ›¸
    â”œâ”€â”€ testing-guide.md        # ãƒ†ã‚¹ãƒˆæ‰‹é †æ›¸
    â”œâ”€â”€ websocket-messages.md   # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µãƒ³ãƒ—ãƒ«é›†
    â””â”€â”€ matching_flow.md        # ãƒãƒƒãƒãƒ³ã‚°è©³ç´°ãƒ•ãƒ­ãƒ¼
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **actix-web** - HTTPã‚µãƒ¼ãƒãƒ¼
- **actix-web-actors** - WebSocketã‚µãƒãƒ¼ãƒˆ
- **actix** - ã‚¢ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆã‚²ãƒ¼ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
- **tokio** - éåŒæœŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
- **serde** - JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
- **uuid** - ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
- **chrono** - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç®¡ç†
- **sqlx** - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ (SQLite)

### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

#### 60Hzæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 

```rust
// tokio::time::intervalã§16.67msé–“éš”ã®é«˜ç²¾åº¦ã‚¿ã‚¤ãƒãƒ¼
ctx.run_interval(Duration::from_millis(16), |act, _ctx| {
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–° & é…ä¿¡
});
```

#### ä¸¦è¡Œå‡¦ç†

- **Arc<Mutex<HashMap>>** - è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸¦è¡Œå‡¦ç†
- **mpsc::unbounded_channel** - éåŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡
- **Actixã‚¢ã‚¯ã‚¿ãƒ¼** - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é§†å‹•ã®çŠ¶æ…‹ç®¡ç†

#### ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—

ä»•æ§˜ã«åŸºã¥ãã€ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿæ–½ã€‚ã‚µãƒ¼ãƒãƒ¼ã¯çµæœã‚’å—ä¿¡ã—ã¦é©ç”¨ã€‚

## âš¡ éæ©Ÿèƒ½è¦ä»¶

- âœ… **60HzçŠ¶æ…‹æ›´æ–°** - tokio::intervalã§å®Ÿç¾
- âœ… **1000çµ„åŒæ™‚å‡¦ç†** - åŠ¹ç‡çš„ãªéåŒæœŸå‡¦ç†
- âœ… **å¿œç­”æ™‚é–“<100ms** - actix-webã®é«˜æ€§èƒ½ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
- âœ… **REST/WebSocketä½¿ã„åˆ†ã‘** - é©åˆ‡ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«é¸æŠ

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å€‹äººå­¦ç¿’ç”¨ã§ã™ã€‚

## ğŸ¤ è²¢çŒ®

ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½è¦æœ›ã¯ Issue ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

## ğŸ“š å‚è€ƒè³‡æ–™

- [ä»•æ§˜æ›¸](doc/specification.md)
- [ãƒ†ã‚¹ãƒˆæ‰‹é †æ›¸](doc/testing-guide.md)
- [WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜](doc/websocket-messages.md)
- [ãƒãƒƒãƒãƒ³ã‚°è©³ç´°ãƒ•ãƒ­ãƒ¼](doc/matching_flow.md)
- [actix-webå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://actix.rs/)
