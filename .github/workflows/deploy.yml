name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RUST_VERSION: "1.89"
  SSH_HOSTNAME: umamon-ssh.localhouse.jp
  DEPLOY_SERVER: ct108
  DEPLOY_PATH: Projects

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build release binary
        run: |
          # musl-toolsのインストール
          sudo apt-get update
          sudo apt-get install -y musl-tools

          # muslターゲットの追加
          rustup target add x86_64-unknown-linux-musl

          # musl向けにビルド
          cargo build --release --target x86_64-unknown-linux-musl --bin umaibou-monster-game-server

          # deploy.shが期待する場所にバイナリを移動
          mkdir -p target/release
          cp target/x86_64-unknown-linux-musl/release/umaibou-monster-game-server target/release/server
          chmod +x target/release/server

      - name: Install cloudflared
        run: |
          # cloudflaredのインストール
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      - name: Setup SSH
        run: |
          # SSH秘密鍵の設定
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # SSH configファイルの設定
          cp .github/ssh_config ~/.ssh/config
          chmod 600 ~/.ssh/config

          echo "SSH setup completed"

      - name: Verify SSH connection
        run: |
          # SSH接続確認
          ssh umamon "echo 'SSH connection successful'"

      - name: Deploy to server
        run: |
          chmod +x scripts/deploy.sh
          scripts/deploy.sh
        env:
          DEPLOY_SERVER: ${{ env.DEPLOY_SERVER }}
          DEPLOY_USER: ${{ env.DEPLOY_SERVER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}

      - name: Verify deployment
        run: |
          ssh umamon "pgrep -f server && echo 'Service is running'"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/config
